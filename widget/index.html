<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Lovely Venice Apartments â€“ Bus Widget</title>

<style>
/* ================= BASE ================= */
* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  margin: 0;
  padding: 0;
  background: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
  color: #1a1a1a;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.4;
}

#lv-container {
  max-width: 100%;
  margin: 0 auto;
  padding: 16px 0 0 0;
}

/* ================= HEADER ================= */
#lv-header {
  text-align: center;
  margin-bottom: 16px;
  padding: 0 16px;
}

#lv-header-title {
  font-size: 18px;
  font-weight: 700;
  color: #1e3a5f;
  margin-bottom: 4px;
}

#lv-header-subtitle {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 8px;
}

/* ================= LIVE BADGE ================= */
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.6; }
}

#lv-live {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #ecfdf5;
  padding: 4px 10px;
  border-radius: 12px;
}

.lv-live-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #10b981;
  animation: pulse 2s infinite;
}

.lv-live-text {
  font-size: 11px;
  font-weight: 700;
  color: #059669;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ================= SELECT MENU ================= */
#lv-menu-row {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  padding: 0 16px;
}

.lv-select {
  flex: 1;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  font-weight: 500;
  background: #fff;
  color: #1a1a1a;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  min-height: 48px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.lv-select:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.lv-lang {
  width: 65px;
  padding: 12px 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  font-weight: 600;
  background: #fff;
  color: #1a1a1a;
  cursor: pointer;
  text-align: center;
  min-height: 48px;
  -webkit-appearance: none;
  appearance: none;
}

.lv-lang:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* ================= MAIN GRID (2 COLUMNS) ================= */
.lv-main-card {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  background: #fff;
}

.lv-col-left {
  padding: 0 20px 20px 16px;
  border-right: 1px solid #e5e7eb;
}

.lv-col-right {
  padding: 0 16px 20px 20px;
}

/* ================= SCHEDULE SECTIONS ================= */
.lv-schedule-section {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.lv-schedule-section:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.lv-section-header {
  display: none;
}

.lv-section-icon {
  display: none;
}

.lv-section-icon.outbound {
  display: none;
}

.lv-section-icon.inbound {
  display: none;
}

.lv-section-title {
  font-size: 15px;
  font-weight: 700;
  color: #1e3a5f;
  margin-bottom: 10px;
  display: block;
}

/* ================= ORARI ================= */
.lv-summary {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px 14px;
  margin-bottom: 14px;
  font-size: 13px;
  font-weight: 500;
  color: #1e3a5f;
  line-height: 1.5;
}

.lv-times {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.lv-pill {
  padding: 8px 14px;
  border-radius: 20px;
  background: #fff;
  border: 1px solid #cbd5e1;
  font-size: 14px;
  font-weight: 600;
  color: #334155;
  transition: all 0.15s ease;
  min-height: 36px;
  display: inline-flex;
  align-items: center;
}

.lv-pill-next {
  background: #1e3a5f;
  border-color: #1e3a5f;
  color: #fff;
}

.lv-pill-time {
  font-weight: 700;
}

/* ================= DIVIDER ================= */
.lv-divider {
  display: none;
}

/* ================= STOP INFO ================= */
.lv-stop-info {
  display: none;
}

.lv-stop-icon {
  display: none;
}

.lv-stop-details {
  flex: 1;
}

.lv-stop-name {
  font-size: 15px;
  font-weight: 700;
  color: #1e3a5f;
  margin-bottom: 12px;
}

.lv-walk-time {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 16px;
  line-height: 1.4;
}

/* ================= MAPPA ================= */
.lv-map {
  width: 100%;
  height: 280px;
  border: 0;
  border-radius: 12px;
  margin-bottom: 14px;
  background: #f1f5f9;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ================= BOTTONI ================= */
.lv-buttons-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* ================= PREZZI BIGLIETTI ================= */
.lv-prices {
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 10px;
  padding: 14px;
  margin-top: 8px;
}

.lv-prices-title {
  font-size: 14px;
  font-weight: 700;
  color: #166534;
  margin-bottom: 12px;
}

.lv-prices-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.lv-price-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #dcfce7;
}

.lv-price-label {
  font-size: 12px;
  color: #374151;
  font-weight: 500;
}

.lv-price-value {
  font-size: 14px;
  font-weight: 700;
  color: #166534;
}

.lv-btn {
  padding: 14px 16px;
  border-radius: 25px;
  text-align: center;
  text-decoration: none;
  font-weight: 600;
  font-size: 13px;
  border: none;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-height: 48px;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  cursor: pointer;
  user-select: none;
}

.lv-btn-primary {
  background: #2563eb;
  color: white;
}

.lv-btn-secondary {
  background: #2563eb;
  color: white;
}

.lv-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.lv-btn:active {
  transform: scale(0.97);
  background: #1e40af;
}

/* ================= RESPONSIVE TABLET ================= */
@media(max-width:768px){
  .lv-main-card {
    grid-template-columns: 1fr;
  }
  
  .lv-col-left {
    border-right: none;
    border-bottom: 1px solid #e5e7eb;
    padding: 0 16px 24px 16px;
  }
  
  .lv-col-right {
    padding: 24px 16px 20px 16px;
  }
  
  .lv-map {
    height: 240px;
  }
  
  .lv-prices-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* ================= RESPONSIVE MOBILE ================= */
@media(max-width:480px){
  #lv-container {
    padding-top: 12px;
  }
  
  #lv-header {
    margin-bottom: 12px;
    padding: 0 12px;
  }
  
  #lv-header-title {
    font-size: 16px;
  }
  
  #lv-header-subtitle {
    font-size: 12px;
  }
  
  #lv-menu-row { 
    padding: 0 12px;
    margin-bottom: 16px;
    gap: 8px;
  }
  
  .lv-select {
    padding: 10px 12px;
    font-size: 13px;
    min-height: 44px;
  }
  
  .lv-lang {
    width: 58px;
    padding: 10px 6px;
    font-size: 13px;
    min-height: 44px;
  }
  
  .lv-col-left {
    padding: 0 12px 20px 12px;
  }
  
  .lv-col-right {
    padding: 20px 12px 16px 12px;
  }
  
  .lv-section-title {
    font-size: 14px;
    margin-bottom: 8px;
  }
  
  .lv-summary {
    padding: 8px 12px;
    font-size: 12px;
    margin-bottom: 12px;
  }
  
  .lv-times {
    gap: 6px;
  }
  
  .lv-pill {
    padding: 7px 12px;
    font-size: 13px;
    min-height: 34px;
  }
  
  .lv-stop-name {
    font-size: 14px;
    margin-bottom: 10px;
  }
  
  .lv-walk-time {
    font-size: 12px;
    margin-bottom: 12px;
  }
  
  .lv-map { 
    height: 200px;
    border-radius: 10px;
  }
  
  .lv-buttons-row { 
    gap: 8px; 
  }
  
  .lv-btn { 
    padding: 12px 10px;
    font-size: 12px;
    min-height: 44px;
    border-radius: 22px;
  }
  
  .lv-schedule-section {
    margin-bottom: 20px;
    padding-bottom: 16px;
  }
  
  .lv-prices {
    padding: 12px;
    margin-top: 6px;
  }
  
  .lv-prices-title {
    font-size: 13px;
    margin-bottom: 10px;
  }
  
  .lv-prices-grid {
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  
  .lv-price-item {
    padding: 8px 10px;
  }
  
  .lv-price-label {
    font-size: 11px;
  }
  
  .lv-price-value {
    font-size: 12px;
  }
}

/* ================= EXTRA SMALL SCREENS ================= */
@media(max-width:360px){
  #lv-header-title {
    font-size: 15px;
  }
  
  .lv-select {
    font-size: 12px;
    padding: 10px 10px;
  }
  
  .lv-lang {
    width: 52px;
    font-size: 12px;
  }
  
  .lv-pill {
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .lv-btn {
    font-size: 11px;
    padding: 10px 8px;
  }
  
  .lv-map {
    height: 180px;
  }
  
  .lv-prices-grid {
    grid-template-columns: 1fr;
    gap: 5px;
  }
  
  .lv-price-item {
    padding: 8px 10px;
  }
}

/* ================= SAFE AREA FOR NOTCHED PHONES ================= */
@supports(padding: max(0px)) {
  #lv-container {
    padding-left: max(0px, env(safe-area-inset-left));
    padding-right: max(0px, env(safe-area-inset-right));
  }
  
  .lv-col-left, .lv-col-right, #lv-menu-row, #lv-header {
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
  }
}

/* ================= DARK MODE SUPPORT ================= */
@media (prefers-color-scheme: dark) {
  /* Kept light for Lodgify consistency */
}

/* ================= BOTTOM BAR MOBILE ================= */
#lv-bottom-bar {
  display: none;
}
</style>
</head>
<body>

<div id="lv-container">

  <!-- HEADER -->
  <div id="lv-header">
    <div id="lv-header-title">ðŸšŒ Lovely Venice Apartments</div>
    <div id="lv-header-subtitle">Orari autobus in tempo reale</div>
    <div id="lv-live">
      <div class="lv-live-dot"></div>
      <div class="lv-live-text" id="lv-live-text">LIVE</div>
    </div>
  </div>

  <!-- SELECT -->
  <div id="lv-menu-row">
    <select id="lv-apartment-select" class="lv-select">
      <option value="sweet">Sweet Dream Apartment</option>
      <option value="skyline">Skyline Apartment</option>
      <option value="dreamstudio">Dream Studio</option>
      <option value="station">Station Apartment</option>
    </select>
    <select id="lv-lang-select" class="lv-lang">
      <option value="it">IT</option>
      <option value="en">EN</option>
    </select>
  </div>

  <!-- MAIN CARD - 2 COLUMNS LAYOUT -->
  <div class="lv-main-card">

    <!-- LEFT COLUMN: SCHEDULES -->
    <div class="lv-col-left">

      <!-- OUTBOUND -->
      <div class="lv-schedule-section">
        <div class="lv-section-title" id="lv-outbound-title"></div>
        <div id="lv-summary-outbound" class="lv-summary"></div>
        <div id="lv-times-outbound" class="lv-times"></div>
      </div>

      <!-- RETURN -->
      <div class="lv-schedule-section">
        <div class="lv-section-title" id="lv-inbound-title"></div>
        <div id="lv-summary-return" class="lv-summary"></div>
        <div id="lv-times-return" class="lv-times"></div>
      </div>

      <!-- TICKET PRICES (moved to left) -->
      <div class="lv-prices" id="lv-prices">
        <div class="lv-prices-title" id="lv-prices-title">ðŸ’¶ Prezzi biglietti</div>
        <div class="lv-prices-grid">
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="priceBus">Biglietto Bus</span><span class="lv-price-value">â‚¬1.50</span></div>
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="priceVaporetto">Biglietto Vaporetto</span><span class="lv-price-value">â‚¬9.50</span></div>
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="pricePass1">Pass 1 giorno</span><span class="lv-price-value">â‚¬25.00</span></div>
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="pricePass2">Pass 2 giorni</span><span class="lv-price-value">â‚¬35.00</span></div>
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="pricePass3">Pass 3 giorni</span><span class="lv-price-value">â‚¬45.00</span></div>
          <div class="lv-price-item"><span class="lv-price-label" data-i18n="pricePass7">Pass 7 giorni</span><span class="lv-price-value">â‚¬65.00</span></div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN: MAP -->
    <div class="lv-col-right">
      <div class="lv-stop-name" id="lv-stop-title"></div>
      <iframe id="lv-map-iframe" class="lv-map"></iframe>
      <div class="lv-walk-time" id="lv-walktime"></div>

      <!-- BUTTONS -->
      <div class="lv-buttons-row">
        <a id="lv-nav-btn" class="lv-btn lv-btn-primary" target="_blank" rel="noopener noreferrer">Open Google Maps</a>
        <a id="lv-ticket-btn" class="lv-btn lv-btn-secondary"
           href="https://www.veneziaunica.it/en/e-commerce/services"
           target="_blank" rel="noopener noreferrer">Acquista biglietto ACTV</a>
      </div>
    </div>

  </div>

</div>

<!-- BOTTOM BAR (hidden) -->
<div id="lv-bottom-bar">
    <a id="lv-bottom-nav-btn" href="#" target="_blank" rel="noopener noreferrer">Navigazione</a>
    <a id="lv-bottom-ticket-btn"
      href="https://www.veneziaunica.it/en/e-commerce/services"
      target="_blank" rel="noopener noreferrer">Biglietti ACTV</a>
</div>


<script>
/* ================= MULTILINGUA ================= */
let LANG = "it";

const I18N = {
  it: {
    outbound: "Verso Venezia (Piazzale Roma)",
    inbound: "Da Venezia â†’ Appartamento",
    stopPiave: "Fermata Piave Fiume",
    stopMiranese: "Fermata Miranese Monteverdi",
    stopVempa: "Fermata Cavalcavia Vempa",
    walkSweet: "Distanza a piedi: 2 minuti dal Sweet Dream Apartment",
    walkSky: "Distanza a piedi: 3 minuti dallo Skyline Apartment",
    walkDreamStudio: "Distanza a piedi: 2 minuti dal Dream Studio",
    walkStation: "Distanza a piedi: 1 minuto dallo Station Apartment",
    nextDepartures: "Prossime partenze",
    noMoreToday: "Nessuna altra corsa per oggi",
    minutes: "min",
    navBtn: "Apri Google Maps",
    navBottom: "Navigazione",
    ticketBtn: "Acquista biglietto ACTV",
    ticketBottom: "Biglietti ACTV",
    live: "LIVE â€“ Aggiornamento in tempo reale",
    busLabel: "Bus",
    nextBus: "Prossimo autobus",
    pricesTitle: "ðŸ’¶ Prezzi biglietti",
    priceBus: "Biglietto Bus",
    priceVaporetto: "Biglietto Vaporetto",
    pricePass1: "Pass 1 giorno",
    pricePass2: "Pass 2 giorni",
    pricePass3: "Pass 3 giorni",
    pricePass7: "Pass 7 giorni"
  },

  en: {
    outbound: "To Venice (Piazzale Roma)",
    inbound: "From Venice â†’ Apartment",
    stopPiave: "Piave Fiume Bus Stop",
    stopMiranese: "Miranese Monteverdi Bus Stop",
    stopVempa: "Cavalcavia Vempa Bus Stop",
    walkSweet: "Walking distance: 2 min from Sweet Dream Apartment",
    walkSky: "Walking distance: 3 min from Skyline Apartment",
    walkDreamStudio: "Walking distance: 2 min from Dream Studio",
    walkStation: "Walking distance: 1 min from Station Apartment",
    nextDepartures: "Next departures",
    noMoreToday: "No more buses today",
    minutes: "min",
    navBtn: "Open Google Maps",
    navBottom: "Navigation",
    ticketBtn: "Buy Tickets Online",
    ticketBottom: "ACTV Tickets",
    live: "LIVE â€“ Real-time update",
    busLabel: "Bus line",
    nextBus: "Next bus",
    pricesTitle: "ðŸ’¶ Ticket prices",
    priceBus: "Bus ticket",
    priceVaporetto: "Vaporetto ticket",
    pricePass1: "1-day pass",
    pricePass2: "2-day pass",
    pricePass3: "3-day pass",
    pricePass7: "7-day pass"
  }
};

/* ================= Fermate â†’ mappe e linee bus ================= */
const STOP_CONFIG = {
  // Sweet Dream Apartment â†’ Piave Fiume, linea 2 di giorno, N1 di notte
  sweet: {
    key: "piave",
    mapQuery: "Fermata bus Piave Fiume Mestre",
    lines: {
      day: "2",
      night: "N1"
    }
  },

  // Skyline Apartment â†’ Piave Fiume, stessa logica di Sweet Dream
  skyline: {
    key: "piave",
    mapQuery: "Fermata bus Piave Fiume Mestre",
    lines: {
      day: "2",
      night: "N1"
    }
  },

  // Dream Studio â†’ Miranese Monteverdi, solo linea 7 (niente notte)
  dreamstudio: {
    key: "miranese",
    mapQuery: "Fermata bus Miranese Monteverdi Mestre",
    lines: {
      day: "7(E-L)",
      night: null       // nessun bus notturno
    },
    multiLine: false
  },

  // Station Apartment â†’ Vempa, linea 2 e linea 7 di giorno, N1 di notte
  station: {
    key: "vempa",
    mapQuery: "Fermata Cavalcavia Vempa Mestre",
    lines: {
      day: ["2", "7(E-L)"],   // entrambe le linee
      night: "N1"
    },
    multiLine: true
  }
};

/* ================= ORARI PIAVE FIUME verso Venezia (Linea 2) ================= */
const OUTBOUND_WEEKDAY ={
"05":["05:02","05:30","05:32","05:47"],
"06":["06:00","06:11","06:12","06:24","06:36","06:48"],
"07":["07:00","07:06","07:12","07:18","07:24","07:30","07:36","07:48"],
"08":["08:00","08:12","08:20","08:24","08:36","08:48"],
"09":["09:00","09:10","09:12","09:24","09:36","09:48"],
"10":["10:00","10:12","10:24","10:36","10:48"],
"11":["11:00","11:12","11:24","11:36","11:48"],
"12":["12:00","12:12","12:24","12:36","12:48"],
"13":["13:00","13:12","13:24","13:36","13:48"],
"14":["14:00","14:12","14:24","14:36","14:48"],
"15":["15:00","15:12","15:24","15:36","15:48"],
"16":["16:00","16:12","16:24","16:36","16:48"],
"17":["17:00","17:12","17:24","17:36","17:48"],
"18":["18:00","18:12","18:24","18:36","18:48"],
"19":["19:00","19:12","19:24","19:36","19:48"],
"20":["20:00","20:12","20:24","20:36","20:48"],
"21":["21:02","21:16","21:31","21:50"],
"22":["22:05","22:17","22:35","22:47","23:05","23:17","23:35","23:47"],
"23":["23:05","23:17","23:35","23:47"],
"00":["00:05","00:17","00:47"]
};

const OUTBOUND_SATURDAY = OUTBOUND_WEEKDAY;

/* FESTIVO - Piave Fiume verso Venezia */
const OUTBOUND_SUNDAY ={
"05":["05:12","05:42"],
"06":["06:12","06:42"],
"07":["07:12","07:42","08:12","08:42"],
"08":["08:12","08:42"],
"09":["09:01","09:12","09:31","09:42"],
"10":["10:01","10:12","10:31","10:42"],
"11":["11:01","11:12","11:31","11:42"],
"12":["12:01","12:12","12:42"],
"13":["13:12","13:42"],
"14":["14:12","14:42"],
"15":["15:12","15:42"],
"16":["16:31","16:42","17:01","17:12","17:31","17:42"],
"17":["17:01","17:12","17:31","17:42"],
"18":["18:01","18:12","18:31","18:42"],
"19":["19:01","19:12","19:31","19:42"],
"20":["20:01","20:12","20:42"],
"21":["21:17","21:47"],
"22":["22:17","22:47"],
"23":["23:17"]
};

/* ================= ORARI MIRANESE MONTEVERDI (Dream Studio) - Linea 7 ================= */
const MIRANESE_OUTBOUND_WEEKDAY ={
"06":["06:00","06:20","06:40"],
"07":["07:00","07:10","07:20","07:24","07:34","07:40"],
"08":["08:00","08:20","08:40"],
"09":["09:00","09:10","09:20","09:40"],
"10":["10:00","10:20","10:40"],
"11":["11:00","11:20","11:40"],
"12":["12:00","12:20","12:40"],
"13":["13:00","13:20","13:40"],
"14":["14:00","14:40"],
"15":["15:00","15:20","15:40"],
"16":["16:00","16:20","16:40"],
"17":["17:00","17:20","17:40"],
"18":["18:00","18:20","18:40"],
"19":["19:00","19:20","19:40"],
"20":["20:00","20:20"]
};

const MIRANESE_OUTBOUND_SATURDAY = MIRANESE_OUTBOUND_WEEKDAY;

const MIRANESE_OUTBOUND_SUNDAY ={
"08":["08:14","08:44"],
"09":["09:14","09:44"],
"10":["10:14","10:44"],
"11":["11:14","11:44"],
"12":["12:14","12:44"],
"13":["13:14","13:44"],
"14":["14:14","14:44"],
"15":["15:14","15:44"],
"16":["16:14","16:44"],
"17":["17:14","17:44"],
"18":["18:14","18:44"],
"19":["19:14","19:44"],
"20":["20:14","20:44"]
};

/* ================= ORARI VEMPA verso Venezia (Linea 2) ================= */
const VEMPA_OUTBOUND_WEEKDAY ={
"05":["05:04","05:33","05:34","05:49"],
"06":["06:02","06:14","06:26","06:38","06:50"],
"07":["07:02","07:08","07:14","07:20","07:26","07:32","07:38","07:50"],
"08":["08:02","08:03","08:14","08:23","08:26","08:35","08:38","08:50"],
"09":["09:02","09:13","09:14","09:26","09:38","09:50"],
"10":["10:02","10:14","10:26","10:38","10:50"],
"11":["11:02","11:14","11:26","11:38","11:50"],
"12":["12:02","12:14","12:26","12:38","12:50"],
"13":["13:02","13:14","13:26","13:38","13:50"],
"14":["14:02","14:14","14:26","14:38","14:50"],
"15":["15:02","15:14","15:26","15:38","15:50"],
"16":["16:02","16:14","16:26","16:38","16:50"],
"17":["17:02","17:14","17:26","17:38","17:50"],
"18":["18:02","18:14","18:26","18:38","18:50"],
"19":["19:02","19:14","19:26","19:38","19:50"],
"20":["20:02","20:14","20:26","20:38","20:50"],
"21":["21:02","21:19","21:31","21:50"],
"22":["22:08","22:19","22:38","22:49"],
"23":["23:08","23:19","23:38","23:49"],
"00":["00:08","00:19","00:49"]
};

const VEMPA_OUTBOUND_SATURDAY = VEMPA_OUTBOUND_WEEKDAY;

/* FESTIVO - Vempa verso Venezia (Linea 2) */
const VEMPA_OUTBOUND_SUNDAY ={
"05":["05:14","05:44"],
"06":["06:14","06:44"],
"07":["07:14","07:44"],
"08":["08:14","08:44"],
"09":["09:03","09:14","09:33","09:44"],
"10":["10:03","10:14","10:33","10:44"],
"11":["11:03","11:14","11:33","11:44"],
"12":["12:03","12:14","12:44"],
"13":["13:14","13:44"],
"14":["14:14","14:44"],
"15":["15:14","15:44"],
"16":["16:33","16:44"],
"17":["17:03","17:14","17:33","17:44"],
"18":["18:03","18:14","18:33","18:44"],
"19":["19:03","19:14","19:33","19:44"],
"20":["20:03","20:14","20:44"],
"21":["21:19","21:49"],
"22":["22:19","22:49"],
"23":["23:19"]
};

const OUTBOUND_NIGHT ={
"00":["00:09","00:35"],"01":["01:05","01:35"],"02":["02:05","02:35"],
"03":["03:05","03:35"],"04":["04:05","04:35"],"05":["05:05"]
};

/* RETURN = Partenze da Venezia A5 (Linea 2) â†’ Piave Fiume */
const RETURN_WEEKDAY ={
"05":["05:30"],
"06":["06:00","06:30","06:46","06:58"],
"07":["07:10","07:22","07:34","07:46","07:58"],
"08":["08:10","08:22","08:34","08:46","08:58"],
"09":["09:10","09:22","09:34","09:46","09:58"],
"10":["10:10","10:22","10:34","10:46","10:58"],
"11":["11:10","11:22","11:34","11:46","11:58"],
"12":["12:10","12:22","12:34","12:46","12:58"],
"13":["13:10","13:22","13:34","13:46","13:58"],
"14":["14:10","14:22","14:34","14:46","14:58"],
"15":["15:10","15:22","15:34","15:46","15:58"],
"16":["16:10","16:22","16:34","16:46","16:58"],
"17":["17:10","17:22","17:34","17:46","17:58"],
"18":["18:10","18:22","18:34","18:46","18:58"],
"19":["19:10","19:22","19:34","19:46","19:58"],
"20":["20:10","20:22","20:34","20:46"],
"21":["21:00","21:15","21:30","21:45"],
"22":["22:00","22:15","22:30","22:45"],
"23":["23:00","23:15","23:30","23:45"],
"00":["00:00","00:20","00:40"]
};

const RETURN_SATURDAY = RETURN_WEEKDAY;

/* FESTIVO = Partenze da Venezia A5 (Linea 2) â†’ Piave Fiume */
const RETURN_SUNDAY ={
"05":["05:45"],
"06":["06:15","06:45"],
"07":["07:15","07:45"],
"08":["08:15","08:45"],
"09":["09:15","09:30","09:45"],
"10":["10:00","10:15","10:30","10:45"],
"11":["11:00","11:15","11:30","11:45"],
"12":["12:15","12:45"],
"13":["13:15","13:45"],
"14":["14:15","14:45"],
"15":["15:15","15:45"],
"16":["16:00","16:15","16:30","16:45"],
"17":["17:00","17:15","17:30","17:45"],
"18":["18:00","18:15","18:30","18:45"],
"19":["19:00","19:15","19:30","19:45"],
"20":["20:00","20:15","20:30","20:45"],
"21":["21:00","21:15","21:45"],
"22":["22:15","22:45"],
"23":["23:15","23:45"],
"00":["00:20","00:40"]
};

const RETURN_NIGHT ={
"00":["00:21","00:51"],"01":["01:21","01:51"],"02":["02:21","02:51"],
"03":["03:21","03:51"],"04":["04:21","04:51"]
};

/* ================= ORARI VEMPA RETURN (Partenze da Venezia A5) - Linea 2 ================= */
const VEMPA_RETURN_WEEKDAY ={
"05":["05:30"],
"06":["06:00","06:30","06:46","06:58"],
"07":["07:10","07:22","07:34","07:46","07:58"],
"08":["08:10","08:22","08:34","08:46","08:58"],
"09":["09:10","09:22","09:34","09:46","09:58"],
"10":["10:10","10:22","10:34","10:46","10:58"],
"11":["11:10","11:22","11:34","11:46","11:58"],
"12":["12:10","12:22","12:34","12:46","12:58"],
"13":["13:10","13:22","13:34","13:46","13:58"],
"14":["14:10","14:22","14:34","14:46","14:58"],
"15":["15:10","15:22","15:34","15:46","15:58"],
"16":["16:10","16:22","16:34","16:46","16:58"],
"17":["17:10","17:22","17:34","17:46","17:58"],
"18":["18:10","18:22","18:34","18:46","18:58"],
"19":["19:10","19:22","19:34","19:46","19:58"],
"20":["20:10","20:22","20:34","20:46"],
"21":["21:00","21:15","21:30","21:45"],
"22":["22:00","22:15","22:30","22:45"],
"23":["23:00","23:15","23:30","23:45"],
"00":["00:00","00:20","00:40"]
};

const VEMPA_RETURN_SATURDAY = VEMPA_RETURN_WEEKDAY;

const VEMPA_RETURN_SUNDAY ={
"05":["05:45"],
"06":["06:15","06:45"],
"07":["07:15","07:45"],
"08":["08:15","08:45"],
"09":["09:15","09:30","09:45"],
"10":["10:00","10:15","10:30","10:45"],
"11":["11:00","11:15","11:30","11:45"],
"12":["12:15","12:45"],
"13":["13:15","13:45"],
"14":["14:15","14:45"],
"15":["15:15","15:45"],
"16":["16:15","16:30","16:45"],
"17":["17:00","17:15","17:30","17:45"],
"18":["18:00","18:15","18:30","18:45"],
"19":["19:00","19:15","19:30","19:45"],
"20":["20:00","20:15","20:30","20:45"],
"21":["21:00","21:15","21:45"],
"22":["22:15","22:45"],
"23":["23:15","23:45"],
"00":["00:20","00:40"]
};

/* ================= ORARI VEMPA LINEA 7 - Verso Venezia ================= */
const VEMPA_L7_OUTBOUND_WEEKDAY ={
"05":["05:20","05:40"],
"06":["06:00","06:15","06:30","06:45"],
"07":["07:00","07:15","07:30","07:45"],
"08":["08:00","08:15","08:30","08:45"],
"09":["09:00","09:20","09:40"],
"10":["10:00","10:20","10:40"],
"11":["11:00","11:20","11:40"],
"12":["12:00","12:20","12:40"],
"13":["13:00","13:20","13:40"],
"14":["14:00","14:20","14:40"],
"15":["15:00","15:20","15:40"],
"16":["16:00","16:20","16:40"],
"17":["17:00","17:20","17:40"],
"18":["18:00","18:20","18:40"],
"19":["19:00","19:20","19:40"],
"20":["20:00","20:30"],
"21":["21:00","21:30"],
"22":["22:00","22:30"],
"23":["23:00"]
};

const VEMPA_L7_OUTBOUND_SATURDAY = VEMPA_L7_OUTBOUND_WEEKDAY;

const VEMPA_L7_OUTBOUND_SUNDAY ={
"08":["08:00","08:30"],
"09":["09:00","09:30"],
"10":["10:00","10:30"],
"11":["11:00","11:30"],
"12":["12:00","12:30"],
"13":["13:00","13:30"],
"14":["14:00","14:30"],
"15":["15:00","15:30"],
"16":["16:00","16:30"],
"17":["17:00","17:30"],
"18":["18:00","18:30"],
"19":["19:00","19:30"],
"20":["20:00","20:30"]
};

/* ================= ORARI VEMPA LINEA 7 - Da Venezia ================= */
const VEMPA_L7_RETURN_WEEKDAY ={
"05":["05:30","05:50"],
"06":["06:10","06:25","06:40","06:55"],
"07":["07:10","07:25","07:40","07:55"],
"08":["08:10","08:25","08:40","08:55"],
"09":["09:10","09:30","09:50"],
"10":["10:10","10:30","10:50"],
"11":["11:10","11:30","11:50"],
"12":["12:10","12:30","12:50"],
"13":["13:10","13:30","13:50"],
"14":["14:10","14:30","14:50"],
"15":["15:10","15:30","15:50"],
"16":["16:10","16:30","16:50"],
"17":["17:10","17:30","17:50"],
"18":["18:10","18:30","18:50"],
"19":["19:10","19:30","19:50"],
"20":["20:10","20:40"],
"21":["21:10","21:40"],
"22":["22:10","22:40"],
"23":["23:10"]
};

const VEMPA_L7_RETURN_SATURDAY = VEMPA_L7_RETURN_WEEKDAY;

const VEMPA_L7_RETURN_SUNDAY ={
"08":["08:10","08:40"],
"09":["09:10","09:40"],
"10":["10:10","10:40"],
"11":["11:10","11:40"],
"12":["12:10","12:40"],
"13":["13:10","13:40"],
"14":["14:10","14:40"],
"15":["15:10","15:40"],
"16":["16:10","16:40"],
"17":["17:10","17:40"],
"18":["18:10","18:40"],
"19":["19:10","19:40"],
"20":["20:10","20:40"]
};

/* ================= UTILS ================= */
function flatten(obj){
  // Avoid relying on flatMap for broader browser support
  return Object.keys(obj).sort().reduce((acc,h) => acc.concat(obj[h] || []), []);
}

function minutes(t){
  if(!t) return Infinity;
  const parts = (""+t).split(":").map(Number);
  if(parts.length<2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1])) return Infinity;
  const [h,m]=parts; return h*60+m;
}

function nextTimes(list,now){
  if(!Array.isArray(list)) return [];
  return list.filter(t=>minutes(t)>=now).slice(0,6);
}

function dayType(d){ const x=d.getDay(); return x===0?"sunday":x===6?"saturday":"weekday"; }
function isNight(d){ return d.getHours()<5; }

/* ================= RENDER ================= */
function renderWidget(){

  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  const dt = dayType(now);
  const night = isNight(now);
  const L = I18N[LANG];

  const apt=document.getElementById("lv-apartment-select").value;
  const stopCfg=STOP_CONFIG[apt];

  document.getElementById("lv-outbound-title").innerText = L.outbound;
  document.getElementById("lv-inbound-title").innerText = L.inbound;
  document.getElementById("lv-live-text").innerText     = L.live;

  const stopNames={
    piave:L.stopPiave,
    miranese:L.stopMiranese,
    vempa:L.stopVempa
  };
  document.getElementById("lv-stop-title").innerText = stopNames[stopCfg.key];

  const walkTxt={
    sweet:L.walkSweet,
    skyline:L.walkSky,
    dreamstudio:L.walkDreamStudio,
    station:L.walkStation
  };
  document.getElementById("lv-walktime").innerText = walkTxt[apt];

  /* MAPPA */
  document.getElementById("lv-map-iframe").src =
    "https://www.google.com/maps?q=" +
    encodeURIComponent(stopCfg.mapQuery) +
    "&hl="+(LANG==="it"?"it":"en")+"&z=18&output=embed";

  /* ORARI */
  let outTable, retTable;
  let outTableL7 = [], retTableL7 = []; // Per linea 7 a Vempa
  const isVempa = (stopCfg.key === "vempa");
  const isMiranese = (stopCfg.key === "miranese");
  const isMultiLine = stopCfg.multiLine === true;

  if(night){
    if(apt==="dreamstudio"){
      outTable=[]; retTable=[];
    } else {
      outTable=flatten(OUTBOUND_NIGHT);
      retTable=flatten(RETURN_NIGHT);
    }
  } else if(dt==="sunday"){
    if(isVempa){
      outTable=flatten(VEMPA_OUTBOUND_SUNDAY);
      retTable=flatten(VEMPA_RETURN_SUNDAY);
      if(isMultiLine){
        outTableL7=flatten(VEMPA_L7_OUTBOUND_SUNDAY);
        retTableL7=flatten(VEMPA_L7_RETURN_SUNDAY);
      }
    } else if(isMiranese){
      outTable=flatten(MIRANESE_OUTBOUND_SUNDAY);
      retTable=flatten(RETURN_SUNDAY);
    } else {
      outTable=flatten(OUTBOUND_SUNDAY);
      retTable=flatten(RETURN_SUNDAY);
    }
  } else if(dt==="saturday"){
    if(isVempa){
      outTable=flatten(VEMPA_OUTBOUND_SATURDAY);
      retTable=flatten(VEMPA_RETURN_SATURDAY);
      if(isMultiLine){
        outTableL7=flatten(VEMPA_L7_OUTBOUND_SATURDAY);
        retTableL7=flatten(VEMPA_L7_RETURN_SATURDAY);
      }
    } else if(isMiranese){
      outTable=flatten(MIRANESE_OUTBOUND_SATURDAY);
      retTable=flatten(RETURN_SATURDAY);
    } else {
      outTable=flatten(OUTBOUND_SATURDAY);
      retTable=flatten(RETURN_SATURDAY);
    }
  } else {
    if(isVempa){
      outTable=flatten(VEMPA_OUTBOUND_WEEKDAY);
      retTable=flatten(VEMPA_RETURN_WEEKDAY);
      if(isMultiLine){
        outTableL7=flatten(VEMPA_L7_OUTBOUND_WEEKDAY);
        retTableL7=flatten(VEMPA_L7_RETURN_WEEKDAY);
      }
    } else if(isMiranese){
      outTable=flatten(MIRANESE_OUTBOUND_WEEKDAY);
      retTable=flatten(RETURN_WEEKDAY);
    } else {
      outTable=flatten(OUTBOUND_WEEKDAY);
      retTable=flatten(RETURN_WEEKDAY);
    }
  }

  const outBox=document.getElementById("lv-times-outbound");
  const retBox=document.getElementById("lv-times-return");
  const outSummary=document.getElementById("lv-summary-outbound");
  const retSummary=document.getElementById("lv-summary-return");

  outBox.innerHTML="";
  retBox.innerHTML="";

  // Per multi-linea, combina gli orari con etichetta linea
  let combinedOut = [];
  let combinedRet = [];
  
  if(isMultiLine && !night){
    // Combina orari linea 2 e linea 7(E-L) con etichetta
    outTable.forEach(t => combinedOut.push({time: t, line: "2"}));
    outTableL7.forEach(t => combinedOut.push({time: t, line: "7(E-L)"}));
    combinedOut.sort((a,b) => minutes(a.time) - minutes(b.time));
    
    retTable.forEach(t => combinedRet.push({time: t, line: "2"}));
    retTableL7.forEach(t => combinedRet.push({time: t, line: "7(E-L)"}));
    combinedRet.sort((a,b) => minutes(a.time) - minutes(b.time));
  } else {
    // Singola linea
    const lineLabel = night ? (stopCfg.lines.night || "N1") : (Array.isArray(stopCfg.lines.day) ? stopCfg.lines.day[0] : stopCfg.lines.day);
    outTable.forEach(t => combinedOut.push({time: t, line: lineLabel}));
    retTable.forEach(t => combinedRet.push({time: t, line: lineLabel}));
  }

  // Filtra prossime partenze
  const nextOut = combinedOut.filter(item => minutes(item.time) >= nowMin).slice(0,6);
  const nextRet = combinedRet.filter(item => minutes(item.time) >= nowMin).slice(0,6);

  if(nextOut.length===0){
    outBox.innerHTML=`<span class="lv-pill">${L.noMoreToday}</span>`;
    outSummary.innerHTML=L.noMoreToday;
  } else {
    nextOut.forEach((item,i)=>{
      const pill=document.createElement("span");
      pill.className="lv-pill"+(i===0?" lv-pill-next":"");
      pill.innerHTML = `<span class="lv-pill-time">${item.line} Â· ${item.time}</span>`;
      outBox.appendChild(pill);
    });
    // Mostra minimo 2 prossime partenze nel summary
    const summaryItems = nextOut.slice(0, 2).map((item, i) => {
      const diff = minutes(item.time) - nowMin;
      const timeDisplay = diff <= 90 ? `<span style="color:#dc2626; font-weight:700;">${diff} min</span>` : item.time;
      return `<strong>${item.line}</strong> â€“ ${timeDisplay}`;
    });
    outSummary.innerHTML=`ðŸšŒ ${L.nextDepartures}: ${summaryItems.join(' Â· ')}`;
  }

  if(nextRet.length===0){
    retBox.innerHTML=`<span class="lv-pill">${L.noMoreToday}</span>`;
    retSummary.innerHTML=L.noMoreToday;
  } else {
    nextRet.forEach((item,i)=>{
      const pill=document.createElement("span");
      pill.className="lv-pill"+(i===0?" lv-pill-next":"");
      pill.innerHTML = `<span class="lv-pill-time">${item.line} Â· ${item.time}</span>`;
      retBox.appendChild(pill);
    });
    // Mostra minimo 2 prossime partenze nel summary
    const summaryItems = nextRet.slice(0, 2).map((item, i) => {
      const diff = minutes(item.time) - nowMin;
      const timeDisplay = diff <= 90 ? `<span style="color:#dc2626; font-weight:700;">${diff} min</span>` : item.time;
      return `<strong>${item.line}</strong> â€“ ${timeDisplay}`;
    });
    retSummary.innerHTML=`ðŸšŒ ${L.nextDepartures}: ${summaryItems.join(' Â· ')}`;
  }

  /* NAVIGAZIONE GOOGLE */
  const baseNavUrl =
    "https://www.google.com/maps/dir/?api=1&destination=" +
    encodeURIComponent(stopCfg.mapQuery) +
    "&travelmode=walking";

  document.getElementById("lv-nav-btn").href=baseNavUrl;
  document.getElementById("lv-nav-btn").innerText=L.navBtn;

  document.getElementById("lv-bottom-nav-btn").href=baseNavUrl;
  document.getElementById("lv-bottom-nav-btn").innerText=L.navBottom;

  /* BOTTONE BIGLIETTI */
  document.getElementById("lv-ticket-btn").innerText=L.ticketBtn;
  document.getElementById("lv-bottom-ticket-btn").innerText=L.ticketBottom;

  /* PREZZI BIGLIETTI */
  const pricesTitle = document.getElementById("lv-prices-title");
  if(pricesTitle) pricesTitle.innerText = L.pricesTitle;
  
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if(L[key]) el.innerText = L[key];
  });
}

/* EVENTI */
const _langSelect = document.getElementById("lv-lang-select");
if(_langSelect){
  _langSelect.addEventListener("change", e => { LANG=e.target.value; renderWidget(); });
}

const _aptSelect = document.getElementById("lv-apartment-select");
if(_aptSelect){
  _aptSelect.addEventListener("change", () => renderWidget());
}

try{
  renderWidget();
}catch(err){
  console.error('Error initializing widget:', err);
}
setInterval(renderWidget, 180000);
</script>

</body>
</html>
